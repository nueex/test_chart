<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candlestick Chart - TradingView</title>
    <script type="text/javascript" src="https://unpkg.com/@tradingview/charting-library@latest/charting_library.min.js"></script>
</head>
<body>
    <div id="tv_chart_container" style="height: 600px; width: 100%;"></div>

    <script>
        const apiUrl = 'https://fxtrade-test.onrender.com/candlestick_data?currency_pair=GBPUSD=X&api_key=81579d9059d44032ba4ca8c40e15267b';

        // دالة لجلب البيانات
        async function fetchCandlestickData() {
            const response = await fetch(apiUrl);
            const data = await response.json();

            const candlesticks = data.map(item => ({
                time: new Date(item["('Datetime', '')"]).getTime() / 1000, // تحويل التاريخ إلى UNIX timestamp
                open: item["('Open', 'GBPUSD=X')"],
                high: item["('High', 'GBPUSD=X')"],
                low: item["('Low', 'GBPUSD=X')"],
                close: item["('Close', 'GBPUSD=X')"]
            }));

            return candlesticks;
        }

        // دالة لتهيئة الشارت
        async function initializeChart() {
            const candlestickData = await fetchCandlestickData();

            const widget = new TradingView.widget({
                autosize: true,
                symbol: 'GBPUSD=X', // هذا يمكن تغييره حسب العملة
                interval: '60', // يمكن تغييره حسب الحاجة
                container_id: "tv_chart_container",
                datafeed: {
                    onReady: cb => cb(),
                    searchSymbols: () => [],
                    resolveSymbol: () => ({
                        name: 'GBPUSD=X',
                        ticker: 'GBPUSD=X',
                        session: '24x7',
                        timezone: 'Etc/UTC',
                        exchange: 'FX',
                        listed_exchange: 'FX',
                        type: 'stock'
                    }),
                    getBars: (symbolInfo, resolution, rangeStartDate, rangeEndDate, onDataCallback, onErrorCallback) => {
                        const filteredData = candlestickData.filter(bar => bar.time >= rangeStartDate && bar.time <= rangeEndDate);
                        onDataCallback(filteredData, { noData: false });
                    }
                },
                library_path: "https://unpkg.com/@tradingview/charting-library@latest/",
                locale: "en",
                disabled_features: ["header_widget", "use_localstorage_for_settings"]
            });
        }

        // تهيئة الشارت عند تحميل الصفحة
        initializeChart();
    </script>
</body>
</html>
